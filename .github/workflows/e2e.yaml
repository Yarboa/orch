name: Integration Testing

on:
  workflow_run:
    workflows: ["Build"]
    types: 
      - completed

jobs:
  test:
    name: cs9 x86_64 e2e
    runs-on: ubuntu-latest
    env:
      ARTIFACTS_DIR: exported-artifacts
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: rpm-artifacts
          path: ${{ env.ARTIFACTS_DIR}}

      - name: Install dependencies
        run: |
          sudo apt-get -y install podman

      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          # Use githash of a tested commit instead of merge commit
          ref: ${{ github.event.pull_request.head.sha }}

      - name: build hirte tests containers
        run: |
          podman build -f tests/Containerfile -t hirte-image .

      - name: run hirte containers
        run: |
          podman run -d --net podman --rm -p 2020:2020 --name hirte-mgr \
          $(podman images *hirte-image --format {{.ID}})
          podman run -d --net podman --rm --name hirte-node-foo \
          $(podman images *hirte-image --format {{.ID}})
          podman run -d --net podman --rm --name hirte-node-bar \
          $(podman images *hirte-image --format {{.ID}})
          PODMAN_NET=$(hostname -I | awk '{print $1}')
          echo "PODMAN_NET=$PODMAN_NET" >> $GITHUB_ENV

      - name: run hirte orchestrator
        run: |
          podman exec -it hirte-node bash -c "man hirte.conf | \
               grep -A 5 \"\[hirte\]\" | sed -e 's/^ *//g' \
               -e 's/journald/stderr/' \
               -e 's/agent.*/foo,bar/' > /etc/hirte/hirte.conf"
          podman exec -it  hirte-mgr \
               bash -c "hirte > mgr.log 2>&1 &"

      - name: run hirte agent-bar
        run: |
          podman exec -it hirte-node-bar bash -c "man hirte-agent.conf| \
               grep -A 6 \"\[hirte-agent\]\" | sed -e 's/^ *//g' \
               -e 's/journald/stderr/' -e 's/127.0.0.1/${{ env.PODMAN_NET }}/'
               -e -e 's/agent.*/bar/' > /etc/hirte/hirte.conf"
          podman exec -it hirte-agent-bar \
          bash -c "hirte-agent > bar.log 2>&1 &"
          podman exec -it hirte-agent-bar /usr/bin/pkill --signal TERM hirte-agent
          podman exec -it hirte-agent-bar \
          grep "Agent 'bar' connection attempt 0: success" bar.log

      - name: run hirte agent-foo
        run: |
          # Change node name in config file
          podman exec -it hirte-agent-foo \
          sed -i "s/\(NodeName=\)\(.*\)/\1foo/" /hirte/example-hirte-agent.ini
          # Change manager address in config file
          podman exec -it hirte-agent-foo \
          sed -i "s/\(ManagerHost=\)\(.*\)/\1${{ env.PODMAN_NET }}/" /hirte/example-hirte-agent.ini
          podman exec -t hirte-agent-foo \
          su - test-user -c  "(/usr/local/bin/hirte-agent -c \
          /hirte/example-hirte-agent.ini > foo.log 2>&1 &)"
          podman exec -it hirte-agent-foo /usr/bin/pkill --signal TERM hirte-agent
          podman exec -w /home/test-user -u test-user -it hirte-agent-foo \
          grep "Agent 'foo' connection attempt 0: success" foo.log

